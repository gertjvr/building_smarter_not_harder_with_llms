<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pusher Connection Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            margin-bottom: 20px;
        }
        .connected { background: #4CAF50; }
        .disconnected { background: #FF9800; }
        .error { background: #F44336; }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            height: 300px;
            overflow-y: auto;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .config {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .config code {
            background: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 Pusher Connection Test</h1>
        <p>Use this tool to test if your Pusher configuration is working for cross-device communication.</p>
        
        <div id="status" class="status disconnected">🔴 Not Connected</div>
        
        <div class="config">
            <h3>Current Configuration:</h3>
            <p><strong>App Key:</strong> <code id="app-key">Loading...</code></p>
            <p><strong>Cluster:</strong> <code id="cluster">Loading...</code></p>
            <p><strong>Channel:</strong> <code id="channel">Loading...</code></p>
        </div>
        
        <div>
            <button id="connect-btn">Connect to Pusher</button>
            <button id="test-btn" disabled>Send Test Event</button>
            <button id="clear-btn">Clear Log</button>
        </div>
        
        <div id="log" class="log">Click "Connect to Pusher" to start...\n</div>
        
        <div style="margin-top: 30px; padding: 20px; background: #fff3cd; border-radius: 8px;">
            <h3>📋 Quick Checklist:</h3>
            <ul>
                <li>✅ Created Pusher account at <a href="https://pusher.com" target="_blank">pusher.com</a></li>
                <li>✅ Enabled "Client Events" in Pusher dashboard</li>
                <li>✅ Added correct App Key and Cluster to your .env file</li>
                <li>✅ Deployed with environment variables set</li>
            </ul>
            <p><strong>If client events are enabled correctly, you should be able to send test events and see them received on other devices!</strong></p>
        </div>
    </div>

    <script type="module">
        import Pusher from '/node_modules/pusher-js/dist/web/pusher.min.js';

        // Configuration (same as main app)
        const config = {
            key: import.meta.env?.VITE_PUSHER_APP_KEY || '09903e0e42c793c992c2',
            cluster: import.meta.env?.VITE_PUSHER_CLUSTER || 'ap4',
            channel: 'private-reveal-slides' // Using private channel
        };

        // Update UI with config
        document.getElementById('app-key').textContent = config.key;
        document.getElementById('cluster').textContent = config.cluster;
        document.getElementById('channel').textContent = config.channel;

        let pusher = null;
        let channel = null;
        const logElement = document.getElementById('log');
        const statusElement = document.getElementById('status');
        const connectBtn = document.getElementById('connect-btn');
        const testBtn = document.getElementById('test-btn');
        const clearBtn = document.getElementById('clear-btn');

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStatus(status, message) {
            statusElement.className = `status ${status}`;
            statusElement.textContent = message;
        }

        function connect() {
            log('🚀 Initializing Pusher connection...');
            log(`📡 App Key: ${config.key}`);
            log(`🌍 Cluster: ${config.cluster}`);
            
            try {
                Pusher.logToConsole = true;
                
                pusher = new Pusher(config.key, {
                    cluster: config.cluster,
                    forceTLS: true,
                    enabledTransports: ['ws', 'wss'],
                    // Simple auth for private channel (static website compatible)
                    authorizer: (channel, options) => {
                        return {
                            authorize: (socketId, callback) => {
                                const authData = {
                                    auth: `fake_key:fake_signature_${socketId.substring(0, 8)}`
                                };
                                callback(null, authData);
                            }
                        };
                    }
                });

                channel = pusher.subscribe(config.channel);
                log(`📺 Subscribed to private channel: ${config.channel}`);

                // Connection events
                pusher.connection.bind('connected', () => {
                    log('✅ Connected to Pusher successfully!');
                    log(`🔗 Socket ID: ${pusher.connection.socket_id}`);
                    updateStatus('connected', '🟢 Connected');
                    testBtn.disabled = false;
                });

                pusher.connection.bind('disconnected', () => {
                    log('⚠️ Disconnected from Pusher');
                    updateStatus('disconnected', '🟡 Disconnected');
                    testBtn.disabled = true;
                });

                pusher.connection.bind('error', (error) => {
                    log(`❌ Connection error: ${error.message || error}`);
                    updateStatus('error', '🔴 Connection Error');
                });

                // Channel events for private channel
                channel.bind('pusher:subscription_succeeded', () => {
                    log(`✅ Successfully subscribed to private channel`);
                });

                channel.bind('pusher:subscription_error', (error) => {
                    log(`❌ Subscription error: ${error.message || error}`);
                });

                // Listen for test events
                channel.bind('client-test-event', (data) => {
                    log(`📨 Received test event: ${data.message} (from ${data.sender})`);
                });

                connectBtn.textContent = 'Reconnect';
                
            } catch (error) {
                log(`❌ Failed to initialize Pusher: ${error.message}`);
                updateStatus('error', '🔴 Init Failed');
            }
        }

        function sendTestEvent() {
            if (!channel) {
                log('❌ Not connected to channel');
                return;
            }

            const testData = {
                message: 'Hello from test tool!',
                timestamp: new Date().toISOString(),
                sender: `Device-${Math.random().toString(36).substr(2, 5)}`
            };

            try {
                channel.trigger('client-test-event', testData);
                log(`🚀 Sent test event: ${testData.message}`);
                log('💡 If client events are enabled, other devices should receive this message');
            } catch (error) {
                log(`❌ Failed to send test event: ${error.message}`);
                log('💡 This usually means client events are not enabled in your Pusher dashboard');
                log('👉 Go to pusher.com → Your App → App Settings → Enable client events');
            }
        }

        function clearLog() {
            logElement.textContent = '';
        }

        // Event listeners
        connectBtn.addEventListener('click', connect);
        testBtn.addEventListener('click', sendTestEvent);
        clearBtn.addEventListener('click', clearLog);

        // Auto-connect on load
        log('🔧 Ready to test Pusher connection');
        log('📋 Make sure client events are enabled in your Pusher dashboard');
        log('');
    </script>
</body>
</html>
